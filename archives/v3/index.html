<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>BTCUSDT Chart</title>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        body {
            margin: 0;
            background: #111;
            color: #ddd;
            font-family: Arial, sans-serif;
        }

        #controls {
            padding: 10px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        #chart-wrapper {
            resize: vertical;
            overflow: hidden;
            height: 500px;
            /* initial height */
            min-height: 200px;
            max-height: 90vh;
            border-bottom: 2px solid #333;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        button {
            background: #333;
            color: #ddd;
            border: 1px solid #555;
            padding: 5px 10px;
            cursor: pointer;
        }

        button:hover {
            background: #444;
        }

        input[type="file"] {
            color: #ddd;
        }
    </style>
</head>

<body>

    <!-- Controls -->
    <div id="controls">
        <input type="file" id="csvInput" accept=".csv">
        <button id="loadBtn">Load CSV</button>
        <button onclick="trade('buy')">Buy</button>
        <button onclick="trade('sell')">Sell</button>
    </div>

    <!-- Resizable Chart Container -->
    <div id="chart-wrapper">
        <div id="chart"></div>
    </div>

    <script>
        /* ---------------- Chart Setup ---------------- */

        const chartContainer = document.getElementById("chart");

        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                background: { color: "#111" },
                textColor: "#DDD",
            },
            grid: {
                vertLines: { color: "#222" },
                horzLines: { color: "#222" },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        const candles = chart.addSeries(
            LightweightCharts.CandlestickSeries,
            {
                upColor: "#26a69a",
                downColor: "#ef5350",
                borderVisible: false,
                wickUpColor: "#26a69a",
                wickDownColor: "#ef5350",
            }
        );

        /* ---------------- Resize Observer ---------------- */

        const resizeObserver = new ResizeObserver(entries => {
            for (const entry of entries) {
                chart.applyOptions({
                    width: entry.contentRect.width,
                    height: entry.contentRect.height,
                });
            }
        });
        resizeObserver.observe(document.getElementById("chart-wrapper"));

        /* ---------------- WebSocket (Live Data) ---------------- */

        const ws = new WebSocket("ws://localhost:8000/ws/candles");

        ws.onmessage = (e) => {
            const candle = JSON.parse(e.data);
            candles.update(candle);
        };

        /* ---------------- CSV Loader ---------------- */

        document.getElementById("loadBtn").onclick = async () => {
            const fileInput = document.getElementById("csvInput");
            if (!fileInput.files.length) return;

            const form = new FormData();
            form.append("file", fileInput.files[0]);

            const res = await fetch("http://localhost:8000/load-csv", {
                method: "POST",
                body: form,
            });

            const data = await res.json();

            candles.setData(data);
            chart.timeScale().fitContent();
        };
    
        // keep a global array of trade markers
        const tradeMarkers = [];

        async function trade(side) {
            const quantity = prompt("Enter quantity:") || 0.01;

            // get last candle
            const lastCandle = candles.data().slice(-1)[0];
            const price = lastCandle.close;

            const res = await fetch("http://localhost:8000/trade", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({
                    symbol: "BTCUSDT",
                    side,
                    price: price,
                    quantity: parseFloat(quantity)
                })
            });

            const data = await res.json();
            console.log("Trade placed:", data);

            if (data.success) {
                const marker = {
                    time: lastCandle.time,               // marker aligned with last candle
                    position: side === "buy" ? "belowBar" : "aboveBar",
                    color: side === "buy" ? "#26a69a" : "#ef5350",
                    shape: side === "buy" ? "arrowUp" : "arrowDown",
                    text: `${side.toUpperCase()} ${data.trade.quantity}`
                };

                tradeMarkers.push(marker);

                // Apply markers via series options (v5)
                candles.applyOptions({ markers: tradeMarkers });
            }
        }
    </script>

</body>

</html>